name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
      
      - name: Install dependencies
        run: |
          # Check if Gemfile is in current directory or lightning-dialer subdirectory
          if [ -f "Gemfile" ]; then
            bundle install
          elif [ -f "lightning-dialer/Gemfile" ]; then
            cd lightning-dialer && bundle install
          else
            echo "Error: Gemfile not found"
            exit 1
          fi
      
      - name: Run tests (if you have tests)
        run: |
          # Uncomment when you add tests
          # bundle exec rspec
          echo "Tests would run here"
      
      - name: Deploy to Render (via Render API)
        if: github.ref == 'refs/heads/main'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          # Trigger Render deployment
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json"
      
      # Alternative: Deploy to Heroku
      # - name: Deploy to Heroku
      #   if: github.ref == 'refs/heads/main'
      #   uses: akhileshns/heroku-deploy@v3.12.12
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: "your-app-name"
      #     heroku_email: "your-email@example.com"


